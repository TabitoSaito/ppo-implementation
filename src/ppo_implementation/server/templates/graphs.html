<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Run Dashboard</title>

    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        background: #f5f5f5;
        margin: 0;
        padding: 20px;
      }

      h1,
      h2 {
        text-align: center;
        color: #333;
      }

      .controls {
        display: flex;
        justify-content: center;
        gap: 15px;
        flex-wrap: wrap;
        margin-bottom: 10px;
      }

      button {
        background-color: #1f77b4;
        color: white;
        border: none;
        padding: 10px 20px;
        font-size: 15px;
        border-radius: 8px;
        cursor: pointer;
      }

      button:hover {
        background-color: #155a8a;
      }

      .last-update {
        text-align: center;
        font-size: 14px;
        color: #555;
        margin-bottom: 30px;
      }

      .section {
        margin-top: 40px;
      }

      .container {
        display: flex;
        flex-direction: column; /* <<< untereinander */
        align-items: center;
        gap: 30px;
      }

      .card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        padding: 15px;
        max-width: 900px;
        width: 100%;
        position: relative;
      }

      /* media */
      img,
      video {
        width: 100%;
        border-radius: 8px;
        display: block;
      }

      /* fade */
      .fade-in {
        animation: fadeIn 0.5s ease-out forwards;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* metadata */
      .meta-toggle {
        margin-top: 8px;
        font-size: 13px;
        cursor: pointer;
        color: #1f77b4;
        text-align: right;
      }

      .meta-table {
        margin-top: 8px;
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
        display: none;
      }

      .meta-table td {
        padding: 4px 6px;
        border-bottom: 1px solid #eee;
      }

      .meta-table td:first-child {
        font-weight: bold;
        color: #555;
      }

      /* badge */
      .badge {
        position: absolute;
        top: 8px;
        left: 8px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 12px;
      }
    </style>
  </head>

  <body>
    <h1>Run Dashboard</h1>

    <div class="controls">
      <button onclick="window.location.href='{{ url_for('runs') }}'">
        ‚Üê Back to Runs
      </button>
      <button id="refreshBtn">Refresh</button>
    </div>

    <div class="last-update" id="lastUpdate">Last update: 0s ago</div>

    <!-- ===== GRAPHS ===== -->

    <div class="section">
      <h2>Graphs</h2>
      <div class="container" id="graphContainer"></div>
    </div>

    <!-- ===== VIDEOS ===== -->

    <div class="section">
      <h2>Videos</h2>
      <div class="container" id="videoContainer"></div>
    </div>

    <script>
      const runName = "{{ run }}";

      const graphContainer = document.getElementById("graphContainer");
      const videoContainer = document.getElementById("videoContainer");
      const refreshBtn = document.getElementById("refreshBtn");
      const lastUpdate = document.getElementById("lastUpdate");

      const knownGraphs = new Set();
      const knownVideos = new Set();

      let lastUpdateTime = Date.now();

      /* ===== helpers ===== */

      function createMetadataTable(meta) {
        const table = document.createElement("table");
        table.className = "meta-table";

        Object.entries(meta).forEach(([k, v]) => {
          if (k === "src") return;

          const row = document.createElement("tr");
          row.innerHTML = `<td>${k}</td><td>${v}</td>`;
          table.appendChild(row);
        });

        return table;
      }

      function createToggle(table) {
        const toggle = document.createElement("div");
        toggle.className = "meta-toggle";
        toggle.textContent = "Show metadata";

        toggle.onclick = () => {
          const open = table.style.display === "table";
          table.style.display = open ? "none" : "table";
          toggle.textContent = open ? "Show metadata" : "Hide metadata";
        };

        return toggle;
      }

      /* ===== graphs ===== */

      function createGraphCard(obj) {
        const card = document.createElement("div");
        card.className = "card fade-in";

        const img = document.createElement("img");
        img.dataset.src = obj.src;
        img.src = `/static/${obj.src}?t=${Date.now()}`;

        const table = createMetadataTable(obj);
        const toggle = createToggle(table);

        card.append(img, toggle, table);
        return card;
      }

      function updateGraphs(imgs) {
        imgs.forEach((obj) => {
          if (!knownGraphs.has(obj.src)) {
            knownGraphs.add(obj.src);
            graphContainer.appendChild(createGraphCard(obj));
          } else {
            const img = document.querySelector(`img[data-src="${obj.src}"]`);
            if (img) img.src = `/static/${obj.src}?t=${Date.now()}`;
          }
        });
      }

      /* ===== videos ===== */

      function createVideoCard(obj) {
        const card = document.createElement("div");
        card.className = "card fade-in";

        if (obj.episode !== undefined) {
          const badge = document.createElement("div");
          badge.className = "badge";
          badge.textContent = `Episode ${obj.episode}`;
          card.appendChild(badge);
        }

        const video = document.createElement("video");
        video.src = `/static/${obj.src}`;
        video.muted = true;
        video.preload = "auto";
        video.playsInline = true;

        video.addEventListener("loadeddata", () => {
          video.play().catch(() => {});
        });

        video.addEventListener("ended", () => {
          setTimeout(() => {
            video.currentTime = 0;
            video.play().catch(() => {});
          }, 1000);
        });

        const table = createMetadataTable(obj);
        const toggle = createToggle(table);

        card.append(video, toggle, table);
        return card;
      }

      function updateVideos(vids) {
        vids.forEach((obj) => {
          if (!knownVideos.has(obj.src)) {
            knownVideos.add(obj.src);
            videoContainer.appendChild(createVideoCard(obj));
          }
        });
      }

      /* ===== polling ===== */

      async function pollAssets() {
        const res = await fetch(`/assets/${runName}`);
        const data = await res.json();

        updateGraphs(data.imgs || []);
        updateVideos(data.vids || []);

        lastUpdateTime = Date.now();
      }

      refreshBtn.onclick = pollAssets;

      pollAssets();
      setInterval(pollAssets, 5000);

      setInterval(() => {
        const s = Math.floor((Date.now() - lastUpdateTime) / 1000);
        lastUpdate.textContent = `Last update: ${s}s ago`;
      }, 1000);
    </script>
  </body>
</html>
